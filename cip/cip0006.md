---
author: lawrennd
created: '2025-07-02'
id: '0006'
last_updated: '2026-01-04'
status: Accepted
related_requirements: ["0003"]
tags:
- cip
- cli
- interface
- workflow
title: Two-Stage Command Line Interface for lamd Utilities
---

# CIP-0006: Two-Stage Command Line Interface for lamd Utilities

## Summary

This CIP proposes to refactor the command line utilities in the lamd project to use a two-stage process. The first stage generates a standardized interface file describing the inputs, outputs, and computations. The second stage executes the command using this interface file, enabling better workflow management, reproducibility, and integration with publish/subscribe services.

**Status Update (2026-01-04)**: Accepted with phased implementation approach. Starting with `maketalk`/`makecv` as pilots before expanding to other utilities.

## Motivation

Currently, lamd command line utilities operate as single-stage commands, which can make it difficult to:
- Track and document the full workflow
- Integrate with external workflow managers or publish/subscribe systems
- Reproduce or audit computations
- Separate configuration from execution

A two-stage approach, inspired by the interface pattern in [referia](https://github.com/lawrennd/referia/blob/main/referia/config/interface.py), would improve transparency, modularity, and automation.

## Detailed Description

The proposed two-stage process is as follows:

1. *Stage 1: Interface File Generation*
   - The CLI utility generates an interface file (YAML or similar) with the following structure:
     ```
     input:
       # Specify the input files here
     output:
       # Specify the output files here
     compute:
       # Specify the computations that are done on the two
     ```
   - This file documents the workflow and can be registered with a publish/subscribe service.

2. *Stage 2: Execution*
   - The CLI utility (or a runner) reads the interface file and executes the specified computation.
   - This enables decoupling of configuration and execution, and allows for workflow orchestration.

## Implementation Plan

### Revised Approach: New `lamd` CLI Utility (Accepted 2026-01-04)

**Key Decision**: Create a new `lamd` command-line utility with subcommands instead of modifying existing tools. This provides 100% backward compatibility while enabling modern workflow features.

**Phase 1: Core `lamd` CLI with talk/cv subcommands**
1. Create new `lamd/cli.py` entry point
   - Implements subcommand architecture (like `git`, `docker`)
   - `lamd talk` - equivalent to `maketalk` with two-stage workflow
   - `lamd cv` - equivalent to `makecv` with two-stage workflow
   
2. Design the interface file schema (YAML format)
   - Leverage existing `Interface` class from `lamd.config.interface`
   - Extend to include `compute` section describing transformations
   
3. Two-stage workflow as default behavior
   - `lamd talk --generate talk.md` - Generate interface file only
   - `lamd talk --execute talk.interface.yml` - Execute from interface
   - `lamd talk talk.md` - Default: generate + execute (backward compatible)
   
4. Keep legacy commands unchanged
   - `maketalk` and `makecv` continue working exactly as before
   - No breaking changes for existing users
   - Users migrate to `lamd` when ready

**Phase 2: Expand subcommands** (Based on Phase 1 feedback)
- `lamd field` - Modern version of `mdfield`
- `lamd list` - Modern version of `mdlist`
- `lamd deps` - Dependency analysis (building on CIP-0009 work)
- Shared flags and configuration across subcommands

**Phase 3: Advanced features** (Optional, based on Phase 2 results)
- Workflow orchestration: `lamd workflow run *.interface.yml`
- Integration with external workflow managers
- Workflow visualization: `lamd workflow visualize talk.interface.yml`
- Automated dependency tracking and caching

## Backward Compatibility

- The existing single-stage CLI behavior should be preserved as a default.
- The two-stage workflow should be opt-in via a flag or subcommand.

## Implementation Status

**Phase 1: New `lamd` CLI Utility**
- [ ] Create lamd/cli.py entry point with subcommand dispatcher
- [ ] Configure `lamd` command in pyproject.toml
- [ ] Design interface schema (extend lamd.config.interface.Interface)
- [ ] Implement `lamd talk` subcommand (with --generate and --execute)
- [ ] Implement `lamd cv` subcommand (with --generate and --execute)
- [ ] Refactor common logic from maketalk/makecv for reuse
- [ ] Ensure 100% backward compatibility (maketalk/makecv unchanged)
- [ ] Write comprehensive tests (unit + integration)
- [ ] Document new CLI and migration path
- [ ] Gather user feedback

**Phase 2: Expand based on feedback** (Decision point)
- [ ] Evaluate Phase 1 success and user adoption
- [ ] Consider: `lamd field`, `lamd list`, `lamd deps` subcommands
- [ ] Decide on publish/subscribe integration
- [ ] Plan workflow orchestration features

**Phase 3: Advanced features** (Conditional on Phase 2 success)
- [ ] External workflow manager integration
- [ ] Workflow visualization tools
- [ ] Automated dependency tracking

## Testing Strategy

**Phase 1 Testing:**
- Unit tests for interface file generation and parsing
- Integration tests for two-stage workflows with maketalk/makecv
- Backward compatibility tests (ensure existing usage still works)
- Performance tests (ensure interface generation doesn't add significant overhead)

**Phase 2+ Testing:**
- Additional integration tests as features expand
- Tests for publish/subscribe registration (if implemented)
- Cross-utility workflow tests

## Related Work

- [GitHub Issue #1](https://github.com/lawrennd/lamd/issues/1) (original proposal)
- [referia interface.py](https://github.com/lawrennd/referia/blob/main/referia/config/interface.py)

## Author
lawrennd

## Date
2025-07-02