---
author: "lawrennd"
created: "2026-01-03"
id: "0008"
last_updated: "2026-01-03"
status: "Proposed"
related_requirements: ["0005"]
tags:
- cip
- performance
- lynguine
- integration
title: "Integrate Lynguine Server Mode for Fast Builds"
---

# CIP-0008: Integrate Lynguine Server Mode for Fast Builds

## Summary

This CIP proposes integrating lynguine's server mode into lamd's `mdfield` and `mdlist` utilities to dramatically reduce build times by eliminating repeated startup overhead. This achieves the performance requirement (REQ-0005) by leveraging lynguine's stateful data sessions.

## Motivation

### The Problem

Current lamd builds are dominated by tool startup overhead:

**CV Build Performance (Current)**:
- 38 subprocess calls per build (27 `mdfield` + 11 `mdlist`)
- Each call: ~1.9s startup (Python + pandas + lynguine imports)
- Actual work: ~5s
- **Total: ~72s (93% overhead)**

This makes the iterative edit-build-review cycle frustrating. Users spend most of their time waiting for tools to start up rather than doing actual work.

### Why lynguine Server Mode

Lynguine recently implemented **Phase 5: Stateful Data Sessions** (lynguine CIP-0008, now complete) which:
- Maintains `CustomDataFrame` instances in a long-running server
- Provides focus-based navigation API (mirrors `CustomDataFrame`)
- Transfers only indices/values over HTTP, not full DataFrames
- Amortizes startup costs across multiple operations

**Expected Performance** (with server mode):
- 1 session creation: ~1.9s (one-time cost)
- 38 lightweight operations: ~10ms each = ~0.38s
- **Total: ~2.3s (35-40x faster)**

This directly addresses REQ-0005 by making builds fast and dominated by actual work rather than overhead.

## Detailed Description

### Architecture

```
┌─────────────┐         ┌──────────────────┐         ┌─────────────┐
│   mdfield   │ ──────> │ lynguine.client  │ ──────> │  lynguine   │
│   (lamd)    │  HTTP   │  (auto-start)    │  HTTP   │   server    │
└─────────────┘         └──────────────────┘         └─────────────┘
       │                                                      │
       │                                                      │
       └──────> Creates session for config file              │
                                                              │
                Sends lightweight commands: ─────────────────┘
                - set_index('person_1')
                - set_column('name')
                - get_value()
```

### Integration Points

**1. mdfield utility** (extracts single field values):
```python
# Current: New subprocess each call
# mdfield neil-lawrence.yml name
# → Start Python → Import lynguine → Load config → Extract → Exit

# Proposed: Use lynguine server session
# mdfield neil-lawrence.yml name
# → Connect to server → Use cached session → Extract → Return
```

**2. mdlist utility** (generates markdown lists):
```python
# Current: New subprocess each call
# mdlist publications neil-lawrence.yml
# → Start Python → Import lynguine → Load config → Generate → Exit

# Proposed: Use lynguine server session
# mdlist publications neil-lawrence.yml
# → Connect to server → Use cached session → Filter → Generate → Return
```

### Implementation Approach

**Option A: Transparent Integration** (Recommended)
- Add `--use-server` flag to `mdfield` and `mdlist`
- When enabled, use `ServerClient` instead of direct lynguine calls
- Session management handled internally
- Backwards compatible (default: direct mode)

**Option B: Separate Utilities**
- Create `mdfield-server` and `mdlist-server` variants
- Keeps original utilities unchanged
- Users opt-in by using server variants

**Option C: Auto-Detection**
- Tools automatically detect if server is running
- Use server mode if available, fallback to direct mode
- Most transparent, but adds complexity

**Recommendation**: Option A with environment variable support:
- `LAMD_USE_SERVER=1` enables server mode globally
- `--use-server` / `--no-server` flags override per-call
- Clear, explicit, backwards compatible

### Session Management

**Strategy: Config-based session caching**
- Key sessions by interface file path
- Reuse sessions across calls for same config
- Automatic cleanup on server idle timeout
- No state leakage between different configs

```python
# Pseudocode for mdfield
def extract_field(interface_file, field, use_server=False):
    if not use_server:
        # Current direct mode
        return extract_field_direct(interface_file, field)
    
    # Server mode
    client = ServerClient(auto_start=True, idle_timeout=300)
    
    # Session identified by interface file
    session = client.get_or_create_session(
        interface_file=interface_file,
        directory=get_directory_from_path(interface_file)
    )
    
    # Use CustomDataFrame API (same as direct mode)
    session.set_column(field)
    value = session.get_value()
    
    return value
```

## Implementation Plan

### Phase 1: Basic Integration (1-2 weeks)
- [ ] Add lynguine server mode client as dependency
- [ ] Implement `--use-server` flag in `mdfield`
- [ ] Test with simple CV configs
- [ ] Measure performance improvement
- [ ] Document usage

### Phase 2: Full Integration (1-2 weeks)
- [ ] Add server mode to `mdlist`
- [ ] Implement session caching strategy
- [ ] Add environment variable support
- [ ] Update makefiles to use server mode
- [ ] Comprehensive testing

### Phase 3: Documentation and Migration (1 week)
- [ ] Update lamd documentation
- [ ] Create migration guide
- [ ] Add performance benchmarks
- [ ] Update CI/CD to use server mode

## Backward Compatibility

**Fully backward compatible**:
- Server mode is opt-in (flag or environment variable)
- Default behavior unchanged (direct mode)
- No breaking changes to existing workflows
- Users can adopt incrementally

## Testing Strategy

**Performance Testing**:
- Benchmark CV build times (before/after)
- Measure startup overhead reduction
- Verify 10x+ improvement target

**Functional Testing**:
- Verify field extraction accuracy (server vs direct)
- Test list generation correctness
- Ensure no state leakage between configs
- Test error handling and fallback behavior

**Integration Testing**:
- Test with real CV and talk configs
- Test in CI/CD environment
- Test server auto-start and shutdown
- Test session cleanup

## Implementation Status
- [ ] Phase 1: Basic Integration
- [ ] Phase 2: Full Integration
- [ ] Phase 3: Documentation and Migration

## References
- **Requirement**: REQ-0005 (Build Operations Complete in Reasonable Time)
- **External**: lynguine CIP-0008 (Server Mode) - Phase 5 complete
- **External**: lynguine REQ-0007 (Fast Repeated Access)
- **Tenets**: 
  - `compose-dont-monolith`: Leveraging external lynguine service
  - `academic-rigor-through-tooling`: Fast tools enable better workflows

## Author
LAMD Development Team

## Date
2026-01-03

