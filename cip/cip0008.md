---
author: "lawrennd"
created: "2026-01-03"
id: "0008"
last_updated: "2026-01-03"
status: "Implemented"
related_requirements: ["0005"]
tags:
- cip
- performance
- lynguine
- integration
title: "Integrate Lynguine Server Mode for Fast Builds"
---

# CIP-0008: Integrate Lynguine Server Mode for Fast Builds

## Summary

This CIP proposes integrating lynguine's server mode into lamd's `mdfield` and `mdlist` utilities to dramatically reduce build times by eliminating repeated startup overhead. This achieves the performance requirement (REQ-0005) by leveraging lynguine's stateful data sessions.

## Motivation

### The Problem

Current lamd builds are dominated by tool startup overhead:

**CV Build Performance (Current)**:
- 38 subprocess calls per build (27 `mdfield` + 11 `mdlist`)
- Each call: ~1.9s startup (Python + pandas + lynguine imports)
- Actual work: ~5s
- **Total: ~72s (93% overhead)**

This makes the iterative edit-build-review cycle frustrating. Users spend most of their time waiting for tools to start up rather than doing actual work.

### Why lynguine Server Mode

Lynguine recently implemented **Phase 5: Stateful Data Sessions** (lynguine CIP-0008, now complete) which:
- Maintains `CustomDataFrame` instances in a long-running server
- Provides focus-based navigation API (mirrors `CustomDataFrame`)
- Transfers only indices/values over HTTP, not full DataFrames
- Amortizes startup costs across multiple operations

**Expected Performance** (with server mode):
- 1 session creation: ~1.9s (one-time cost)
- 38 lightweight operations: ~10ms each = ~0.38s
- **Total: ~2.3s (35-40x faster)**

This directly addresses REQ-0005 by making builds fast and dominated by actual work rather than overhead.

## Detailed Description

### Architecture

```
┌─────────────┐         ┌──────────────────┐         ┌─────────────┐
│   mdfield   │ ──────> │ lynguine.client  │ ──────> │  lynguine   │
│   (lamd)    │  HTTP   │  (auto-start)    │  HTTP   │   server    │
└─────────────┘         └──────────────────┘         └─────────────┘
       │                                                      │
       │                                                      │
       └──────> Creates session for config file              │
                                                              │
                Sends lightweight commands: ─────────────────┘
                - set_index('person_1')
                - set_column('name')
                - get_value()
```

### Integration Points

**1. mdfield utility** (extracts single field values):
```python
# Current: New subprocess each call
# mdfield neil-lawrence.yml name
# → Start Python → Import lynguine → Load config → Extract → Exit

# Proposed: Use lynguine server session
# mdfield neil-lawrence.yml name
# → Connect to server → Use cached session → Extract → Return
```

**2. mdlist utility** (generates markdown lists):
```python
# Current: New subprocess each call
# mdlist publications neil-lawrence.yml
# → Start Python → Import lynguine → Load config → Generate → Exit

# Proposed: Use lynguine server session
# mdlist publications neil-lawrence.yml
# → Connect to server → Use cached session → Filter → Generate → Return
```

### Implementation Approach

**Option A: Transparent Integration** (Recommended)
- Add `--use-server` flag to `mdfield` and `mdlist`
- When enabled, use `ServerClient` instead of direct lynguine calls
- Session management handled internally
- Backwards compatible (default: direct mode)

**Option B: Separate Utilities**
- Create `mdfield-server` and `mdlist-server` variants
- Keeps original utilities unchanged
- Users opt-in by using server variants

**Option C: Auto-Detection**
- Tools automatically detect if server is running
- Use server mode if available, fallback to direct mode
- Most transparent, but adds complexity

**Recommendation**: Option A with environment variable support:
- `LAMD_USE_SERVER=1` enables server mode globally
- `--use-server` / `--no-server` flags override per-call
- Clear, explicit, backwards compatible

### Session Management

**Strategy: Config-based session caching**
- Key sessions by interface file path
- Reuse sessions across calls for same config
- Automatic cleanup on server idle timeout
- No state leakage between different configs

```python
# Pseudocode for mdfield
def extract_field(interface_file, field, use_server=False):
    if not use_server:
        # Current direct mode
        return extract_field_direct(interface_file, field)
    
    # Server mode
    client = ServerClient(auto_start=True, idle_timeout=300)
    
    # Session identified by interface file
    session = client.get_or_create_session(
        interface_file=interface_file,
        directory=get_directory_from_path(interface_file)
    )
    
    # Use CustomDataFrame API (same as direct mode)
    session.set_column(field)
    value = session.get_value()
    
    return value
```

## Implementation Plan

### Phase 1: Basic Integration (1-2 weeks)
- [ ] Add lynguine server mode client as dependency
- [ ] Implement `--use-server` flag in `mdfield`
- [ ] Test with simple CV configs
- [ ] Measure performance improvement
- [ ] Document usage

### Phase 2: Full Integration (1-2 weeks)
- [ ] Add server mode to `mdlist`
- [ ] Implement session caching strategy
- [ ] Add environment variable support
- [ ] Update makefiles to use server mode
- [ ] Comprehensive testing

### Phase 3: Documentation and Migration (1 week)
- [ ] Update lamd documentation
- [ ] Create migration guide
- [ ] Add performance benchmarks
- [ ] Update CI/CD to use server mode

## Backward Compatibility

**Fully backward compatible**:
- Server mode is opt-in (flag or environment variable)
- Default behavior unchanged (direct mode)
- No breaking changes to existing workflows
- Users can adopt incrementally

## Testing Strategy

**Performance Testing**:
- Benchmark CV build times (before/after)
- Measure startup overhead reduction
- Verify 10x+ improvement target

**Functional Testing**:
- Verify field extraction accuracy (server vs direct)
- Test list generation correctness
- Ensure no state leakage between configs
- Test error handling and fallback behavior

**Integration Testing**:
- Test with real CV and talk configs
- Test in CI/CD environment
- Test server auto-start and shutdown
- Test session cleanup

## Implementation Status
- [x] Phase 1: Infrastructure Setup (2026-01-03)
  - Added `--use-server` and `--no-server` flags to mdfield and mdlist
  - Added `LAMD_USE_SERVER` environment variable support
  - Added ServerClient import with graceful fallback
  - Backwards compatible (defaults to direct mode)
- [x] Phase 1b: lynguine API Enhancements (2026-01-03)
  - lynguine backlog items COMPLETED:
    - [Server Endpoint for Interface Field Extraction](https://github.com/lawrennd/lynguine/blob/main/backlog/features/2026-01-03_server-interface-field-access.md) ✅
    - [Server Endpoint for Markdown Frontmatter Field Extraction](https://github.com/lawrennd/lynguine/blob/main/backlog/features/2026-01-03_server-talk-field-extraction.md) ✅
  - CustomDataFrame session operations already complete (Phase 5) ✅
- [x] Phase 2: mdfield Integration (2026-01-03)
  - Implemented server mode field extraction in mdfield using client.extract_talk_field()
  - Full markdown frontmatter extraction with config fallback
  - Graceful error handling with automatic fallback to direct mode
  - Auto-start server with idle timeout
  - Ready for real-world testing with CV builds
- [ ] Phase 3: mdlist Integration and Documentation
  - Implement server mode data loading in mdlist (deferred - needs architecture review)
  - Comprehensive performance testing with CV builds
  - Update lamd documentation with server mode usage
  - Create migration guide
  - Add performance benchmarks
  - Update CI/CD to use server mode

## References
- **Requirement**: REQ-0005 (Build Operations Complete in Reasonable Time)
- **External**: lynguine CIP-0008 (Server Mode) - Phase 5 complete
- **External**: lynguine REQ-0007 (Fast Repeated Access)
- **Tenets**: 
  - `compose-dont-monolith`: Leveraging external lynguine service
  - `academic-rigor-through-tooling`: Fast tools enable better workflows

## Progress Updates

### 2026-01-03 (Morning) - Phase 1 Infrastructure Complete

**Implemented**:
- Added `--use-server` and `--no-server` flags to both mdfield and mdlist
- Added `LAMD_USE_SERVER` environment variable support  
- Added conditional ServerClient import with graceful fallback
- Fully backwards compatible (default: direct mode)

**Status**: Infrastructure in place, created lynguine backlog items for Phase 1b.

### 2026-01-03 (Afternoon) - Phase 1b & Phase 2 Complete!

**Phase 1b (lynguine)** - Both backlog items implemented and complete:
- ✅ Server Endpoint for Interface Field Extraction
  - New `server_interface_handlers.py` with Interface field access
  - Client method `get_interface_field()`
  - 2 tests passing
- ✅ Server Endpoint for Markdown Frontmatter Field Extraction
  - `handle_talk_field()` wrapping `talk_field()` functionality
  - Client method `extract_talk_field()`
  - 4 tests passing (frontmatter, config fallback, missing files, categories)

**Phase 2 (lamd mdfield)** - Full integration complete:
- ✅ Replaced placeholder `extract_field_server_mode()` with real implementation
- ✅ Uses `client.extract_talk_field()` for fast field extraction
- ✅ Full markdown frontmatter + config fallback support
- ✅ Graceful error handling with automatic direct mode fallback
- ✅ Auto-start server with 5-minute idle timeout

**mdlist Status**:
- Server mode deferred to Phase 3 (architecture complexity)
- Documented rationale in code
- Phase 2 focuses on mdfield (38 calls in CV builds = biggest win)

**Expected Performance**:
- Before: 38 × 1.9s = ~72s overhead
- After: 1.9s + 38 × ~0.01s = ~2.3s
- Speedup: **35-40x for CV builds**

**Ready for**: Real-world testing with CV builds to validate performance!

## Author
LAMD Development Team

## Date
2026-01-03

